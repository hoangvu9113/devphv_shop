{% extends 'shopping/main.html' %}

{% block title %}
ALKA | Checkout
{% endblock title %}

{% block content %}
{% load humanize %}
{% load static %}
<!-- breadcrumb-area start -->
<div class="breadcrumb-area">
    <div class="container">
        <div class="row">
            <div class="col-12"><br><br>
                <div class="row breadcrumb_box  align-items-center">
                    <div class="col-lg-6 col-md-6 col-sm-6 text-center text-sm-left">
                        <h2 class="breadcrumb-title">Checkout</h2>
                    </div>
                    <div class="col-lg-6  col-md-6 col-sm-6">
                        <!-- breadcrumb-list start -->
                        <ul class="breadcrumb-list text-center text-sm-right">
                            <li class="breadcrumb-item"><a href="{% url 'index' %}">Home</a></li>
                            <li class="breadcrumb-item active">Checkout</li>
                        </ul>
                        <!-- breadcrumb-list end -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- breadcrumb-area end -->


<div class="site-wrapper-reveal border-bottom">

    <!-- checkout start -->
    <div class="checkout-main-area section-space--ptb_90">
        <div class="container">
            <div class="row">
                <div class="col-lg-7">
                    <div class="customer-zone mb-30">
                        <p class="cart-page-title">Returning customer? <a class="checkout-click-login" href="#"> Click
                                here to login</a></p>
                        <div class="checkout-login-info">
                            <p>If you have shopped with us before, please enter your details in the boxes below. If you
                                are a new customer, please proceed to the Billing & Shipping section.</p>
                            <form action="#" class="account-form-box">
                                <div class="single-input mt-20">
                                    <label>Username or email <span class="required">*</span></label>
                                    <input type="email">
                                </div>
                                <div class="single-input mt-20">
                                    <label>Password <span class="required">*</span></label>
                                    <input type="password" placeholder="Password">
                                </div>
                                <div class="checkbox-wrap mt-10">
                                    <label class="label-for-checkbox inline mt-15">
                                        <input class="input-checkbox" name="rememberme" type="checkbox" id="rememberme"
                                            value="forever"> <span>Remember me</span>
                                    </label>
                                </div>
                                <div class="button-box mt-15">
                                    <a href="#" class="btn btn--lg btn--black">Login</a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-lg-5">
                    <div class="customer-zone mb-30">
                        <p class="cart-page-title">Have a coupon? <a class="checkout-click" href="#">Click here to enter
                                your code</a></p>
                        <div class="checkout-coupon-info">
                            <p>If you have a coupon code, please apply it below.</p>
                            <form action="#">
                                <input type="text" placeholder="Coupon code">
                                <input type="submit" value="Apply Coupon">
                            </form>
                        </div>
                    </div>
                </div>
            </div>


            <div class="checkout-wrap">
                <div class="row">
                    <div class="col-lg-7">
                        <div class="billing-info-wrap mr-100" id='form-info'>
                            <h6 class="mb-20">Billing Details</h6>
                            <form id='form'>
                                <div class="row">
                                    <div class="col-lg-6 col-md-6">
                                        <div class="billing-info mb-25">
                                            <label>First name <span class="required" title="required">*</span></label>
                                            <input type="text" name="name">
                                        </div>
                                    </div>
                                    <div class="col-lg-6 col-md-6">
                                        <div class="billing-info mb-25">
                                            <label>Last name <span class="required" title="required">*</span></label>
                                            <input type="text" name="lname">
                                        </div>
                                    </div>
                                    <div class="col-lg-12">
                                        <div class="billing-info mb-25">
                                            <label>Email Address <span class="required"
                                                    title="required">*</span></label>
                                            <input type="text" name="email">
                                        </div>
                                    </div>
                                    <div class="col-lg-12">
                                        <div class="billing-info mb-25">
                                            <label>Address <span class="required" title="required">*</span></label>
                                            <input class="billing-address" placeholder="House number and street name"
                                                type="text" name="address">
                                        </div>
                                    </div>
                                    <div class="col-lg-12">
                                        <div class="billing-info mb-25">
                                            <label>Town / City <span class="required" title="required">*</span></label>
                                            <input type="text" name="city">
                                        </div>
                                    </div>
                                    <!-- <div class="col-lg-12">
                                        <div class="billing-select mb-25">
                                            <label>District <span class="required" title="required">*</span></label>
                                            <select class="select-active">
                                                <option>Azerbaijan</option>
                                                <option>Bahamas</option>
                                                <option>Bahrain</option>
                                                <option>Bangladesh</option>
                                                <option>Barbados</option>
                                            </select>
                                        </div>
                                    </div> -->
                                    <div class="col-lg-12 col-md-12">
                                        <div class="billing-info mb-25">
                                            <label>Postcode / ZIP (optional) <span class="required"
                                                    title="required">*</span></label>
                                            <input type="text" name="zipcode">
                                        </div>
                                    </div>
                                    <div class="col-lg-12 col-md-12">
                                        <div class="billing-info mb-25">
                                            <label>Phone <span class="required" title="required">*</span></label>
                                            <input type="text" name="mobile">
                                        </div>
                                    </div>
                                </div>

                                <div class="additional-info-wrap">
                                    <h6 class="mb-10">Additional information</h6>
                                    <label>Order notes (optional)</label>
                                    <textarea
                                        placeholder="Notes about your order, e.g. special notes for delivery. "></textarea>
                                </div>
                                <br>
                                <input id="form-button" class="btn--full btn--black btn--lg text-center" type='submit'
                                    value="Continue">
                            </form>
                        </div>
                        <div class="place-order mt-30 hidden" id="payment-info">
                            <div id="paypal-button-container"></div>
                            <!-- <button id="make-payment" class="btn--full btn--black btn--lg text-center">Make
                                Payment</button> -->
                        </div>
                    </div>

                    <div class="col-lg-5 fixed-bg">
                        <div class="your-order-wrappwer tablet-mt__60 small-mt__60">
                            <h6 class="mb-20">Your order</h6>
                            <div class="your-order-area">
                                <div class="your-order-wrap gray-bg-4">
                                    <div class="your-order-info-wrap">
                                        <div class="your-order-info">
                                            <ul>
                                                <li>Product <span>Total</span></li>
                                            </ul>
                                        </div>
                                        {% for item in items %}
                                        <div class="your-order-middle">
                                            <ul>
                                                <li>{{item.product.name}} X {{item.order_quantity}}<span>
                                                        {{item.product.price|intcomma}}</span></li>
                                            </ul>
                                        </div>
                                        {% endfor %}


                                        <div class="your-order-info order-total">
                                            <ul>
                                                <li><strong>Total</strong> <span>{{ orders.get_cart_total|intcomma}} VND
                                                    </span></li>
                                            </ul>
                                        </div>

                                        <div class="payment-area mt-30">
                                            <div class="single-payment">
                                                <h6 class="mb-10">Check payments</h6>
                                                <p>Please send a check to Store Name, Store Street, Store Town, Store
                                                    State / County, Store Postcode.</p>
                                            </div>
                                            <div class="single-payment mt-20">
                                                <h6 class="mb-10">What is PayPal?</h6>
                                                <p>Pay via PayPal; you can pay with your credit card if you donâ€™t have a
                                                    PayPal account.</p>
                                            </div>
                                        </div>
                                    </div>

                                </div>

                            </div>
                            <div class="payment-method">

                                <p class="mt-30">Your personal data will be used to process your order, support your
                                    experience throughout this website, and for other purposes described in our <a
                                        href="#">privacy policy</a>.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- checkout end -->

</div>

<script src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD"></script>

<script>
    var total = '{{order.get_cart_total}}'
    // Render the PayPal button into #paypal-button-container
    paypal.Buttons({

        style: {
            color: 'blue',
            shape: 'pill',
            label: 'pay',
            height: 40
        },
        // Set up the transaction
        createOrder: function (data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amout: {
                        value: parsefloat(total).toFixed(2)
                    }
                }]
            });
        },

        //Finnalize the transcation
        onApprove: function (data, actions) {
            return actions.order.capture().then(function (details) {
                //Show a success message to the buyer
                submitFormData()
            });
        }
    }).render('#paypal-button-container');
</script>

<script type="text/javascript">
    var shipping = '{{order.shipping}}'


    /* if (shipping == 'False') {
        document.getElementById('shipping-info').innerHTML = ''
    }
    if (user == 'AnonymousUser') {
        document.getElementById('shipping-info').innerHTML = ''
    }
    if (user != 'AnonymousUser') {
        //Hide entire form if user is logged in and shipping is false
        document.getElementById('form-info').classList.add('hidden');
        //show payment if logged in user wants to buy an itrem that does not required shipping
        document.getElementById('payment-info').classList.remove('hidden');
    }*/

    var form = document.getElementById('form')

    form.addEventListener('submit', function (e) {
        e.preventDefault()
        console.log('Form submited...')
        document.getElementById('form-button').classList.add('hidden')
        document.getElementById('payment-info').classList.remove('hidden')
    })

    /*document.getElementById('make-payment').addEventListener('click', function (e) {
        submitFormData()

    })*/

    function submitFormData() {
        console.log('Payment button clicked')

        var userFormData = {
            'name': null,
            'email': null,
            'total': total,

        }
        var shippingInfo = {
            'address': null,
            'city': null,
            'state': null,
            'zipcode': null,
            'mobile': null
        }
        if (shipping != 'True') {
            shippingInfo.address = form.address.value
            shippingInfo.city = form.city.value
            shippingInfo.zipcode = form.zipcode.value
            shippingInfo.mobile = form.mobile.value
        }
        if (user == 'AnonymousUser') {
            userFormData.name = form.name.value
            userFormData.email = form.email.value

        }
        var url = '/process-order/'
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({ 'form': userFormData, 'shipping': shippingInfo })
        })
            .then((response) => response.json())
            .then((data) => {
                console.log('Success:', data);
                alert('Transaction completed');

                cart = {}
                document.cookie = 'cart=' + JSON.stringify(cart) + ";domain=;path=/"

                window.location.href = "{% url 'index' %}"
            })
    }
</script>
{% endblock content %}